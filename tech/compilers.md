## 3 词法分析

## 4 语法分析

### 4.1 引论

文法：某种语言的语法规约

语法分析器：从此词法分析器获得一个由词法单元组成的串，并验证改串可由源语言的文法生成

处理文法的语法分析器大致可分为三类：

- 通用的：Cocke-Younger-Kasami算法、Earler算法
- 自顶向下的
- 自底向上的

通用方法的效率很低，一般不能用于编译器，最高效的自顶向下及自底向上方法都只能处理某些文法子类，且其中的**LL、LR文法**足以描述现代编程语言的大部分语法构造，手工实现的语法分析器常用LL文法，LR文法类的分析器则通常用自动化工具构造而成。

#### 错误恢复

检测到错误时，语法分析器可施行如下几种错误恢复策略：

- 恐慌模式恢复：不断丢弃输入的符号，直到找到通常为界限符的同步词法单元（synchronizing token）
- 短语层次恢复：对余下的输入进行局部纠正，需要小心选择替换方法以免死循环
- 错误产生式：在语言的语法中加入特殊产生式以应对常见错误

### 4.2 上下文无关文法

一个上下文无关文法的组成有：

- 终结符号：即词法单元，是组成串的基本符号
- 非终结符号：表示串的集合的语法变量，给出了语言的层次结构
- 开始符号：指定某个非终结符号而成，符合表示的串集合即为文法生成的语言，在文法中其产生式首先被列出
- 产生式：描述了将终结符号和非终结符号组合成串的方法，组成为：
  - 产生头/左部：非终结符号
  - 箭头
  - 产生式体/右部：零个或多个终结符合和非终结符号

把产生式看作重写规则，那么推导就是从开始符号出发，把一个非终结符号重写为它的某个产生式体的过程。用$\dot{\Rightarrow}$来表示可经过零步或多步推导出的关系，由此有以下几个概念：

- 句型（sentential form）：$S$为开始符号，且$S \dot{\Rightarrow} \alpha$，则$\alpha$为$S$的一个句型，$\alpha$中可存在终结/非终结符号，也可为空串
- 句子（sentence）：不包好非终结符号的句型
- 语言（language）：一个文法生成语言是它的所有句子的集合
- 上下文无关语言（context-free language）：可通过文法生成的语言

根据推导过程中的替换顺序，可分为：

- 最左推导：替换时总选择每个句型的最左非终结符号，写作$\alpha \dot{\underset{lm}\Rightarrow} \beta$
- 最右推导：替换时总选择每个句型的最右非终结符号，写作$\alpha \dot{\underset{rm}\Rightarrow} \beta$

语法分析树是推导的图形化表示形式，它过滤了推导过程中对非终结符应用产生式的顺序，因此语法分析树和最左/最右推导之间存在一对一的关系。如果一个文法可以为某个句子生成多棵语法分析书，则该文法具有**二义性**（ambiguous）。

文法是比正则表达式表达能力更强的表示方法，可以使用正则表达式描述的构造都能用文法来描述，反之则不然，即每个正则语言都是一个上下文无关语言。

### 4.3 设计文法

正则表达式描述的东西都可以由文法描述，但还是用正则表达式来定义一个语言的词法语法的原因：

- 将语言的语法结构分为词法和非词法两个部分，而更容易将编译器的前端模块化
- 语言的词法规则通常都很简单，不必大材小用，正则表达式描述的词法不仅简洁易懂，自动机构造的分析器效率也高于任意文法分析器

#### 消除二义性

一个二义性文法有时可以被改写为无二义性的文法，例如下面的”悬空-else“文法：
$$
stmt \to \text{if}\ expr\ \text{then}\ stmt\ |\ \text{if}\ expr\ \text{then}\ stmt\ \text{else}\ stmt\ |\ \text{other}
$$
改写为无二义性的文法如下：
$$
stmt \to matched\_stmt\ |\ open\_stmt\\
matched\_stmt \to \text{if}\ expr\ \text{then}\ matched\_stmt\ \text{else}\ matched\_stmt\ |\ other\\
open\_stmt \to \text{if}\ expr\ \text{then}\ stmt\ |\ \text{if}\ expr\ \text{then}\ matched\_stmt\ \text{else}\ open\_stmt\\
$$

#### 消除左递归

对于一个立即左递归的产生式：
$$
A \to A\alpha\ |\ \beta
$$
可以通过以下转换将左递归变成右递归：
$$
A \to \beta A^{’} \\
A^{’} \to \alpha A^{’}\ |\ \epsilon
$$
例如下面是几个指明运算符结合性和优先级的LR文法：
$$
E \to E + T\ |\ T \\
T \to T * F\ |\ F \\
F \to (E)\ |\ id
$$
把$+ T$、$* F$都看成一个整体，消除左递归得到：
$$
E \to TE^{'} \\
E^{'} \to +\ TE^{'}\ |\ \epsilon \\
T \to FT^{'} \\
T^{'} \to *\ FT^{'}\ |\ \epsilon \\
F \to (E)\ |\ id
$$


